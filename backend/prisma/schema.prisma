// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// [Legacy / Business] 기존 장비 및 공정 데이터
// ==========================================

model RefEquipment {
  eqpid String @id
  sdwt  String

  // [관계 설정] RefSdwt (N:1) - sdwt 컬럼을 통해 연결
  sdwtRel RefSdwt @relation(fields: [sdwt], references: [sdwt])

  // [관계 설정] 다른 테이블들 (1:1 또는 1:N)
  agentInfo   AgentInfo?
  agentStatus AgentStatus?
  plgErrors   PlgError[]
  eqpPerfs    EqpPerf[]
  lampLifes   EqpLampLife[]

  @@map("ref_equipment")
}

model RefSdwt {
  // 기존 스키마와 통합: id를 PK로 설정하고, sdwt는 유니크 키로 설정하여 RefEquipment와 연결 지원
  id     String   @id @db.Char(7)
  sdwt   String   @unique @db.VarChar(50) // RefEquipment 연결을 위해 unique 설정
  site   String   @db.VarChar(10)
  campus String?  @db.VarChar(50)
  desc   String?  @db.VarChar(50)
  isUse  String   @default("N") @map("is_use") @db.Char(1)
  update DateTime @default(now()) @db.Timestamp()

  // [관계 설정] RefEquipment (1:N)
  equipments RefEquipment[]

  // [New] 사용자 컨텍스트 (사용자가 마지막으로 선택한 SDWT)
  userContexts SysUserContext[]

  @@map("ref_sdwt")
}

model AgentInfo {
  eqpid      String  @id
  pcName     String? @map("pc_name")
  appVer     String? @map("app_ver")
  type       String?
  ipAddress  String? @map("ip_address")
  os         String?
  systemType String? @map("system_type")
  locale     String?
  timezone   String?
  macAddress String? @map("mac_address")
  cpu        String?
  memory     String?
  disk       String?
  vga        String?

  // [관계 설정] RefEquipment (1:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_info")
}

model AgentStatus {
  eqpid          String    @id
  status         String? // 'ONLINE' | 'OFFLINE'
  lastPerfUpdate DateTime? @map("last_perf_update")

  // [관계 설정] RefEquipment (1:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@map("agent_status")
}

model PlgError {
  eqpid      String
  timeStamp  DateTime @map("time_stamp")
  errorId    String?  @map("error_id")
  errorLabel String?  @map("error_label")
  errorDesc     String?  @map("error_desc")
  extraMessage1 String?  @map("extra_message_1")
  extraMessage2 String?  @map("extra_message_2")
  servTs        DateTime @default(now()) @map("serv_ts")

  // [관계 설정] RefEquipment (N:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, timeStamp])
  @@map("plg_error")
}

// [Wafer Metrology] - 수정됨: point를 Int로 변경하여 PK 오류 해결
model PlgWfFlat {
  eqpid       String
  servTs      DateTime  @map("serv_ts")
  lotid       String?
  waferid     Int?
  cassettercp String?
  stagercp    String?
  stagegroup  String?
  film        String?
  datetime    DateTime? @map("datetime")

  // [수정] @@id에 포함되는 필드는 반드시 필수(Required)여야 합니다.
  point       Int       
  
  t1          Float?
  gof         Float?
  z           Float?
  srvisz      Float?
  x           Float?
  y           Float?
  dierow      Float?
  diecol      Float?
  mse         Float?
  thickness   Float?

  @@id([eqpid, servTs, point]) 
  @@map("plg_wf_flat")
}

// [PreAlign] - PreAlignAnalyticsView 에서 사용
model PlgPreAlign {
  eqpid  String
  servTs DateTime @map("serv_ts")
  xmm    Float?
  ymm    Float?
  notch  Float?

  @@id([eqpid, servTs])
  @@map("plg_prealign")
}

// [Wafer Map PDF] - WaferFlatDataView (Wafer Map) 에서 사용
model PlgWfMap {
  eqpid    String
  datetime DateTime
  fileUri  String?  @map("file_uri")

  @@id([eqpid, datetime])
  @@map("plg_wf_map")
}

// [Spectrum] - SpectrumAnalysisView 에서 사용
// *참고: 실제 서비스에서는 월별 동적 테이블(_y2025m01 등)을 사용하지만, Prisma 기본 모델을 위해 정의
model PlgOntoSpectrum {
  eqpid       String
  ts          DateTime
  lotid       String
  waferid     String
  point       Int
  class       String   // 'EXP' | 'GEN'
  wavelengths Float[]  // PostgreSQL Array Type
  values      Float[]  // PostgreSQL Array Type

  @@id([eqpid, ts, lotid, waferid, point, class])
  @@map("plg_onto_spectrum")
}

model EqpPerf {
  eqpid    String
  servTs   DateTime  @map("serv_ts")
  ts       DateTime?
  cpuUsage Float?    @map("cpu_usage")
  memUsage Float?    @map("mem_usage")
  cpuTemp  Float?    @map("cpu_temp")
  gpuTemp  Float?    @map("gpu_temp")
  fanSpeed Float?    @map("fan_speed")

  // [관계 설정] RefEquipment (N:1)
  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, servTs])
  @@map("eqp_perf")
}

model EqpProcPerf {
  eqpid         String
  servTs        DateTime @map("serv_ts")
  processName   String   @map("process_name")
  memoryUsageMB Float?   @map("memory_usage_mb")

  @@id([eqpid, servTs, processName])
  @@map("eqp_proc_perf")
}

model EqpLampLife {
  eqpid        String
  lampId       String    @map("lamp_id")
  servTs       DateTime  @map("serv_ts")
  ageHour      Int?      @map("age_hour")
  lifespanHour Int?      @map("lifespan_hour")
  lastChanged  DateTime? @map("last_changed")

  equipment RefEquipment @relation(fields: [eqpid], references: [eqpid])

  @@id([eqpid, lampId, servTs])
  @@map("eqp_lamp_life")
}

model ItmInfo {
  eqpid       String  @id
  systemModel String? @map("system_model")
  serialNum   String? @map("serial_num")
  application String?
  version     String?
  dbVersion   String? @map("db_version")

  @@map("itm_info")
}

model CfgLotUniformityMetrics {
  metricName String  @id @map("metric_name")
  isExcluded String? @map("is_excluded") // 'Y' or 'N'

  @@map("cfg_lot_uniformity_metrics")
}

// ==========================================
// [New SSO / Auth] 신규 권한 및 메뉴 관리
// ==========================================

// 1. Reference Data (기준 정보 - ref_*)

// [A. Access Control] 접근 허용 화이트리스트 (Gate 2)
model RefAccessCode {
  // 기존 code -> compid 로 변경 (PK 유지)
  compid      String   @id @map("compid") @db.VarChar(3) 
  
  // 기존 type -> deptid 로 변경
  deptid      String   @map("deptid") @db.VarChar(20)
  description String?  @db.VarChar(100)
  isActive    String   @default("Y") @map("is_active") @db.Char(1)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("ref_access_code")
}

// [F. Menus] 메뉴 마스터 (동적 메뉴, 계층형, 배지)
model RefMenu {
  menuId     Int     @id @default(autoincrement()) @map("menu_id")
  label      String  @db.VarChar(50)
  routerPath String? @map("router_path") @db.VarChar(100)
  icon       String? @db.VarChar(50)

  // 계층형 구조 (Grouping)
  parentId Int?      @map("parent_id")
  parent   RefMenu?  @relation("MenuHierarchy", fields: [parentId], references: [menuId])
  children RefMenu[] @relation("MenuHierarchy")

  sortOrder Int @default(0) @map("sort_order")

  // 상태 표시 (Beta/New Badge)
  statusTag String? @map("status_tag") @db.VarChar(10) // 'BETA', 'NEW'

  isVisible String @default("Y") @map("is_visible") @db.Char(1)

  roleMappings CfgMenuRole[]

  @@map("ref_menu")
}

// 2. Configuration Data (설정 정보 - cfg_*)

// [G. Role Mapping] 권한별 메뉴 접근 설정 (User/Guest 등)
model CfgMenuRole {
  role   String @db.VarChar(20)
  menuId Int    @map("menu_id")

  menu RefMenu @relation(fields: [menuId], references: [menuId])

  @@id([role, menuId])
  @@map("cfg_menu_role")
}

// [E. Admin Roles] 관리자 권한 설정 (Admin All Access)
model CfgAdminUser {
  loginId    String   @id @map("login_id") @db.VarChar(50)
  role       String   @default("MANAGER") @db.VarChar(20) // 'ADMIN' | 'MANAGER'
  assignedBy String?  @map("assigned_by") @db.VarChar(50)
  assignedAt DateTime @default(now()) @map("assigned_at")

  @@map("cfg_admin_user")
}

// [H. Guest Whitelist] 예외 접속 허용 설정
model CfgGuestAccess {
  loginId     String   @id @map("login_id") @db.VarChar(50)
  requester   String?  @db.VarChar(50)
  grantedRole String   @default("GUEST") @map("granted_role") @db.VarChar(20)
  validUntil  DateTime @map("valid_until")
  reason      String?  @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("cfg_guest_access")
}

// 3. System Runtime Data (운영 데이터 - sys_*)

// [C. Users] 사용자 접속 통계 (민감정보 없음)
model SysUser {
  loginId     String   @id @map("login_id") @db.VarChar(50)
  loginCount  Int      @default(1) @map("login_count")
  lastLoginAt DateTime @default(now()) @map("last_login_at")
  createdAt   DateTime @default(now()) @map("created_at")

  context SysUserContext?

  @@map("sys_user")
}

// [D. User Context] 사용자 작업 환경 기억
model SysUserContext {
  loginId String @id @map("login_id") @db.VarChar(50)

  // RefSdwt와 연결 (FK: id)
  lastSdwtId String  @map("last_sdwt_id") @db.Char(7)
  sdwtInfo   RefSdwt @relation(fields: [lastSdwtId], references: [id])

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user SysUser @relation(fields: [loginId], references: [loginId])

  @@map("sys_user_context")
}
